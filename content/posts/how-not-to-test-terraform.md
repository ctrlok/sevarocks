+++
title = "Як не треба тестувати Terraform"
date = "2022-07-19"
+++

> Спочатку тут була одна велика стаття про тестування терраформу з теоретичними викладками, схибленою логікою та прикладами, що включали у себе біготню без штанів. Я вирішив поділити її на шматочки, щоб вам, мої любі, було зручніше їх їсти. 

Ця стаття про те, як **не треба** тестувати терраформ. Якщо ви хочете дізнатися як треба - вам [сюди](/posts/how-to-test-terraform/). 

Далі я буду наводити приклади з мого складного життя і розбирати, чому саме так робити не треба. 

# Антипатерн 1: тестування інфраструктури

Якщо одразу не розділити інфраструктуру та код, то замість тестів у вас можуть вилупитися дуже цікаві цуцикопівні. Ні лають, ні квохчуть - тільки дивляться сумними оченятами.

Не потрібно тeстувати, чи є в інфраструктурі якісь ресурси чи конфіги. Покривайте тестами лише код, який ви створили. 

# Антипатерн 2: тестування виключно позитивних сценаріїв

Якщо у вас є певна логіка, яку ви хочете перевірити - треба тестувати не лише успішні кейси, але й неуспішні.

Падіння программи у випадку, якщо данні на вході неправильні — то гарна практика. І ви маєте точно знати, коли ваша функція працює, а коли — ні, а також що з цим робити. 

Інакше ви можете опинитись у ситуації, коли невалідний інпут робить вам бо-бо і розвалює стейт частковим аплаєм. 

# Антипатерн 3: тестування ресурсів

Інша проблема — недовіра. Хороший девопс накопичує психотравми, як білка горішки. І згодом, як розвідник, не довіряє нікому. Навіть собі. 

Ось є в тебе терраформ код, котрий підніймає інстанс:

```tf
data "aws_ami" "ubuntu" {
	...
}

resource "aws_instance" "web" {
  ami           = data.aws_ami.ubuntu.id
  instance_type = "t3.micro"

  tags = {
    Name = "HelloWorld"
  }
}
```

Можна виконати `terraform apply` і подивитися, чи з’явився інстанс. Але що ми з цього отримаємо? 

Правильно - нічого! Отже, майже завжди, це тестувати **не потрібно**.

Ресурси — декларативні, тобто повинні бути вже протестовані, а їх тести повинні бути у [репозиторії провайдера](https://www.terraform.io/plugin/sdkv2/testing/acceptance-tests). 

А якщо ресурси не працюють? Ну кидай ішью, чи піди поридай в шкарпетки - не знаю. Ну чи тестуй, але виключно те, що потребує тестування.

## Тестування датасорсів

Тести датасорсів також є досить дивним підходом.  Наприклад, ось кейс з власного досвіду: 

```tf
data "aws_ami" "ubuntu" {
	...
}
```
Що воно хоче зрозуміти? Просто так, заради фану - ну можна шукати напевно, але... навіщо? 

Якщо ресурс, який ти шукаєш у датасорсі, створений не тобою за кілька хвилин до тесту - це вже не тестування, а моніторинг. Я знаходив інформацію, що справжні козаки моніторять інфру дженкінсом, але це не дуже зручно. До того ж тести будуть довгі і ще будуть падати без зв’язку зі змінами коду. 

# Антипатерн 4: Тестування інпуту

Ще одна популярна міссконцепція — валідація інпуту як тестування. 

```tf
variable "listener_rule_priority" {
 type        = number
 default     = 1
 description = "Priority of listener rule between 1 to 50000"
 validation {
   condition     = var.listener_rule_priority > 0 && var.listener_rule_priority < 50000
   error_message = "The priority of listener_rule must be between 1 to 50000."
 }
}
```

Валідація інпуту то **не є** тестуванная. Це є частина вашої **программи, що ви пишете** мовою терраформ. 

Те саме стосується precondition і postcondition блоків в ресурсах. 

Увесь код, написанний в модулі, є кодом, котрий потребує **додаткового** тестування — чи працює валідація так, як хотілося? Ось що важливо. 

Тому кожен блок з валідацією — ціль для тестів, а не тести.

# Антипатерн 5: тестування великих модулів

Напевно, це найбільш поширена місконцепція. 

Для прикладу, візьмемо модуль, який створює k8s ( внутрі ролі, якісь хелм ресурси і так далєє). Можна ж просто його підняти і подивитись, чи все створено. Ну а чому ні?

Проблема в тому, що у великих модулях нам потрібно тестувати усі можливі комбінації успішних і невдалих сценаріїв. 

Ось наприклад [кількість змінних](https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/variables.tf) у terraform-aws-eks модулі. 

І на кожну комбінацію треба робити окремий аплай і створювати окремий кластер. 

Це дуже дорого. Це дуже повільно, бо може бути 100-200 різних комбінацій і кожен аплай може тривати хвилин по 20-30. 

Тому майже ніколи не потрібно тестувати великі модулі одним махом, краще розбивати їх на частини і тестувати вже їх. 

## Тестування комьюніті модулів

Комьюніті модулі зазвичай не протестовані і створені з велетеньским різноманіттям можливостей. І там ті ж самі проблеми, що в будь-яких великих модулях, помножені на невсеосяжні фантазії авторів модуля.

Якщо ви використовуєте модулі, то, звісно, треба тестувати сценарії. Тільки не всі сценарії, які покриває модуль, а лише ваші. Бо то довго, складно та й як думаєте, чого автори модулів їх не тестують?

Для успішного тестування — комьюніті модулі треба ізолювати по можливостям, створивши навколо них враппер, в котрому зафіксувати лише ті можливості модуля, які потрібні саме вам. 

Але зазвичай простіше написати код самостійно, так щоб він:
а) не потребував тестування (чисті ресурси без логіки)
б) тестування було зробити просто (логіка ізольована у сабмодулях)

# Антипатерн 6: тестування розгортання виключно з чистого листа

Інша велика проблема — це тестування нових ресурсів. 

Якщо тестуєте лише створення, то ви ховаєте від себе цілий пласт того, що терраформ може щось зламати у процесі оновлення.

Наприклад, у вас є тест, що рахує кількість створенних інстансів. Його ціллю є підтвердження, що їх повинно бути 10.

А потім заміняєте count на for_each і терраформ при оновленні видаляє ресурси замість оновлення референсу. 

Тестування змін складне, сумне та похмуре. Простіше всього тестити на різних оточеннях — staging → preprod → prod. 

Але якщо такої змоги немає — можна підняти попередню версію, а вже потім накатити нову зверху і дивитись у віконечко, як проходить міграція. 

# Висновки:

Не треба робити роботу, котра нікому не потрібна і нічого не дає. Краще почитайте [як треба](/posts/how-to-test-terraform/) тестувати терраформ і витрачайте на це мінімум часу, бо життя одне, а зарплатню вам і так будуть платити.  

{{tg(id="UkropsDigest/522")}}
